#!/usr/bin/env bash

# fail fast
set -eu

# parse args
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

BP_BIN_DIR=$BP_DIR/.heroku/bin
BP_SSH_DIR=$BP_DIR/.ssh

BIN_DIR=$BUILD_DIR/.heroku/bin
SSH_DIR=$BUILD_DIR/.ssh

######### Install SSH Relay launcher
ls -la $BP_BIN_DIR
cp $BP_BIN_DIR/ssh_relay $BIN_DIR/ssh_relay
chmod +x $BIN_DIR/ssh_relay

######### Configure SSH Daemon
mkdir -p $SSH_DIR
if [[ ! -f $SSH_DIR/authorized_keys ]]
then
  ssh-keygen -f $SSH_DIR/id_rsa -t rsa -N ''
  cat $SSH_DIR/id_rsa.pub > $SSH_DIR/authorized_keys
fi

cp $BP_SSH_DIR/sshd_config $SSH_DIR/sshd_config

######### Install chisel
CHISEL_VERSION=${CHISEL_VERSION:-'1.2.3'}
if [[ (! -f $BIN_DIR/chisel) || ($CHISEL_VERSION != $(chisel --version)) ]]
then
  wget --quiet -O - https://github.com/jpillora/chisel/releases/download/$CHISEL_VERSION/chisel_linux_amd64.gz | gzip -d > $BIN_DIR/chisel
  chmod +x $BIN_DIR/chisel
fi
