#!/usr/bin/env bash

# fail fast
set -eu

# parse args
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}

BP_BIN_DIR=$BP_DIR/.heroku/bin
BP_SSH_DIR=$BP_DIR/.ssh

BIN_DIR=$BUILD_DIR/.heroku/bin
SSH_DIR=$BUILD_DIR/.ssh

CACHE_SSH_DIR=$CACHE_DIR/.ssh

mkdir -p $BIN_DIR
mkdir -p $SSH_DIR

mkdir -p $CACHE_SSH_DIR

######### Install SSH Relay launcher
cp $BP_BIN_DIR/ssh_relay $BIN_DIR/ssh_relay
chmod +x $BIN_DIR/ssh_relay

######### Configure SSH Daemon
echo $(whoami)
ls -la $CACHE_SSH_DIR
if [[ ! -f $CACHE_SSH_DIR/id_rsa ]]
then
  ssh-keygen -f $CACHE_SSH_DIR/id_rsa -t rsa -N ''
  chmod 640 $CACHE_SSH_DIR/id_rsa
fi

ls -la $SSH_DIR
cp $CACHE_SSH_DIR/id_rsa.pub $SSH_DIR/id_rsa.pub
$CACHE_SSH_DIR/id_rsa.pub >> $SSH_DIR/authorized_keys

cp $BP_SSH_DIR/sshd_config $SSH_DIR/sshd_config

######### Install chisel
CHISEL_VERSION=${CHISEL_VERSION:-'1.2.3'}
if [[ (! -f $BIN_DIR/chisel) || ($CHISEL_VERSION != $(chisel --version)) ]]
then
  wget --quiet -O - https://github.com/jpillora/chisel/releases/download/$CHISEL_VERSION/chisel_linux_amd64.gz | gzip -d > $BIN_DIR/chisel
  chmod +x $BIN_DIR/chisel
fi
